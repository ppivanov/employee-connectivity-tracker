@page "/comm-weights"

@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject HttpClient Http
@inject IJSRuntime jsRuntime
@inject IControllerConnection apiConn

<AuthorizeView>
    <Authorized>
        <div class="communicaiton-weights">
            @if (!initialized)
            {
                <p>Loading...</p>
            }
            else
            {
                if (!isAdmin)
                {
                    <p>You do not have access to this page. Click <a href="/">here</a> to go back.</p>
                }
                else
                {
                    <h3>Manage Communcation Mediums</h3>
                    <EditForm Model="percentagesDict" OnSubmit="@SendWeights" Context="formContext">
                        @foreach (var medium in percentagesDict.Keys)
                        {
                            <div class="comms-input-pair">
                                @if (percentagesDict[medium])
                                {
                                    <InputText @bind-Value=medium.Medium class="" id="Medium" placeholder="Medium type"/>
                                    <InputText @bind-Value=medium.Unit class="" id="Unit" placeholder="Unit"/>
                                }
                                else
                                {
                                    <p>@medium.Medium (@medium.Unit)</p>
                                }
                            </div>
                            <div class="comms-input-pair">
                                <InputNumber @bind-Value=medium.Weight @onchange="(ChangeEventArgs changeWeight) => UpdateWeight(medium, (int)changeWeight.Value)" class="" id="Weight" />%
                            </div>
                            <button @onclick="() => RemoveMedium(medium)">Remove</button>

                            @if (percentagesDict[medium])
                            {
                                <button @onclick="() => SaveMedium(medium)">Save</button>
                            } 
                            else
                            {
                                <button @onclick="() => EditMedium(medium)">Edit</button>
                            }

                            <hr />
                        }
                    </EditForm>
                    <p>Percentage left: @percentageLeft %</p>
                    <button @onclick="() => AddNewMedium()">Add</button>
                }
            }
        </div>
    </Authorized>
</AuthorizeView>

@code {
    bool isAdmin = false;
    bool isSubmitting = false;
    bool initialized = false;
    bool serverMessageIsError = false;
    int percentageLeft = 0;
    Dictionary<CommunicationPercentage, bool> percentagesDict;          // holds true if user selected for edit

    protected override async Task OnInitializedAsync()
    {
        percentageLeft = 100;
        await jsRuntime.InvokeVoidAsync("setPageTitle", "Create Team");
        isAdmin = await apiConn.IsProcessingUserAnAdmin(Http);
        if (isAdmin)
            await GetCommunicationPercentages();

        initialized = true;
    }

    protected async Task GetCommunicationPercentages()
    {
        var token = await apiConn.GetAPITokenAsync();
        if (token != null)
        {
            try
            {
                Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
                var percentages = await Http.GetFromJsonAsync<List<CommunicationPercentage>>($"api/communication/weights");
                InitializeDictionary(percentages);
            }
            catch (AccessTokenNotAvailableException exception)
            {
                exception.Redirect();
            }
        }
    }

    private void InitializeDictionary(List<CommunicationPercentage> percentages)
    {
        percentagesDict = new Dictionary<CommunicationPercentage, bool>();
        foreach (var medium in percentages)
        {
            percentagesDict.Add(medium, false);
        }
    }

    private void SaveMedium(CommunicationPercentage medium)
    {
        percentagesDict[medium] = false;
    }
    private void EditMedium(CommunicationPercentage medium)
    {
        percentagesDict[medium] = true;
    }

    private void AddNewMedium()
    {
        percentagesDict.Add(new CommunicationPercentage(), true);
    }

    private void RemoveMedium(CommunicationPercentage medium)
    {
        percentagesDict.Remove(medium);
    }

    private void UpdateWeight(CommunicationPercentage medium, int newValue)
    {
        //TODO
    }

    private void SendWeights()
    {
        isSubmitting = true;

        isSubmitting = false;
    }
}
